<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>AI UI Designer Pro - Web Edition</title>
    <!-- Bootstrap 5.3.3 for responsive UI -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <!-- Font Awesome for additional icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366F1;
            --secondary: #8B5CF6;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #06B6D4;
            --dark: #1F2937;
            --light: #F9FAFB;
            --border: #E5E7EB;
            --text: #1F2937;
            --text-light: #6B7280;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--light);
            color: var(--text);
            overflow-x: hidden; /* Only hide horizontal overflow */
            overflow-y: auto; /* Allow vertical scrolling */
        }

        .app-container {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 64px);
            width: 100%;
            margin-top: 64px; /* Account for fixed navbar */
            padding-top: 0;
        }

        /* Desktop layout - horizontal flex */
        @media (min-width: 992px) {
            .app-container {
                flex-direction: row;
                height: calc(100vh - 64px);
                overflow: hidden;
            }
        }

        /* Header - Bootstrap Navbar Enhanced */
        .navbar {
            height: 64px;
            padding: 0.5rem 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            z-index: 1030;
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: inherit !important;
        }
        
        .navbar-brand:hover {
            color: inherit !important;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
        }

        .logo-text h1 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }

        .logo-text p {
            font-size: 0.75rem;
            color: var(--text-light);
            margin: 0;
            line-height: 1;
        }

        .navbar-nav {
            gap: 0.5rem;
        }

        .navbar-toggler {
            border: none;
            padding: 0.25rem 0.5rem;
        }
        
        .navbar-toggler:focus {
            box-shadow: none;
        }

        /* Mobile logo adjustments */
        @media (max-width: 576px) {
            .logo-text h1 {
                font-size: 0.9rem;
            }
            
            .logo-text p {
                display: none;
            }
            
            .logo-icon {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            text-decoration: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px; /* Apple HIG minimum touch target */
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-decoration: none;
        }

        .btn:active {
            transform: scale(0.98);
        }

        /* Navbar button improvements */
        .navbar-nav .nav-link.btn {
            margin: 2px 4px;
            border-radius: 6px;
            padding: 8px 16px;
            text-align: left;
            width: 100%;
            justify-content: flex-start;
        }

        @media (min-width: 992px) {
            .navbar-nav .nav-link.btn {
                width: auto;
                margin: 0 2px;
            }
        }

        /* Mobile button optimizations */
        @media (max-width: 991.98px) {
            .navbar-nav {
                padding: 1rem 0;
            }
            
            .navbar-nav .nav-item {
                margin-bottom: 0.5rem;
            }
            
            .navbar-nav .nav-link.btn {
                min-height: 48px;
                font-size: 16px;
                display: flex;
                align-items: center;
                gap: 12px;
            }
            
            .navbar-nav .nav-link.btn i {
                width: 20px;
                text-align: center;
            }
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-icon {
            padding: 8px;
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-icon:hover {
            background: var(--light);
        }

        .btn-icon.active {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        /* Left Sidebar - Mobile First */
        .left-sidebar {
            width: 100%;
            background: white;
            border-bottom: 1px solid var(--border);
            overflow-y: visible;
            box-shadow: none;
            order: 1;
        }

        /* Desktop sidebar */
        @media (min-width: 992px) {
            .left-sidebar {
                width: 320px;
                border-right: 1px solid var(--border);
                border-bottom: none;
                overflow-y: auto;
                box-shadow: 2px 0 8px rgba(0,0,0,0.05);
                height: 100%;
                order: 0;
            }
        }

        .sidebar-header {
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        @media (min-width: 992px) {
            .sidebar-header {
                padding: 24px;
            }
        }

        .sidebar-header h2 {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .sidebar-header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .search-box {
            padding: 16px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        .component-stats {
            margin: 0 16px 16px;
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
            display: flex;
            justify-content: space-around;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
        }

        .components-list {
            padding: 0 16px 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        @media (min-width: 992px) {
            .components-list {
                max-height: none;
            }
        }

        .component-item {
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            min-height: 64px; /* Better touch targets */
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .component-item:hover {
            background: var(--light);
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .component-item:active {
            transform: scale(0.98) translateX(2px);
            background: var(--primary);
            color: white;
        }

        .component-item:active .component-label,
        .component-item:active .component-type {
            color: white;
        }

        /* Mobile component list improvements */
        @media (max-width: 576px) {
            .component-item {
                padding: 16px 12px;
                min-height: 72px; /* Larger touch targets */
            }
            
            .component-icon {
                width: 48px;
                height: 48px;
                font-size: 24px;
                flex-shrink: 0;
            }
            
            .search-input {
                padding: 16px 12px;
                font-size: 16px; /* Prevent zoom on iOS */
                border-radius: 12px;
            }
        }

        .component-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .component-info {
            flex: 1;
        }

        .component-label {
            font-weight: 600;
            font-size: 14px;
        }

        .component-type {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Main Canvas Area - Mobile First */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: visible;
            order: 2;
            min-height: 80vh; /* Much larger on mobile */
        }

        /* Desktop main content */
        @media (min-width: 992px) {
            .main-content {
                overflow: hidden;
                order: 1;
                min-height: auto;
            }
        }

        .canvas-toolbar {
            padding: 16px 24px;
            background: white;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .canvas-info {
            padding: 8px 16px;
            background: var(--light);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .canvas-container {
            flex: 1;
            padding: 16px;
            overflow: auto;
            display: flex;
            justify-content: flex-start; /* Left align on mobile for better scrolling */
            align-items: flex-start;
            touch-action: pan-x pan-y;
            min-height: 70vh; /* Much larger minimum height */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        @media (min-width: 992px) {
            .canvas-container {
                padding: 24px;
                justify-content: center; /* Center on desktop */
                min-height: auto;
            }
        }

        .canvas {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            position: relative;
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
            touch-action: none;
            user-select: none;
            /* Ensure canvas is never too small on mobile */
            min-width: 800px;
            min-height: 600px;
        }

        @media (min-width: 992px) {
            .canvas {
                min-width: auto;
                min-height: auto;
            }
        }

        .canvas.grid {
            background-image: 
                linear-gradient(0deg, transparent 24%, rgba(0,0,0,0.05) 25%, rgba(0,0,0,0.05) 26%, transparent 27%, transparent 74%, rgba(0,0,0,0.05) 75%, rgba(0,0,0,0.05) 76%, transparent 77%, transparent),
                linear-gradient(90deg, transparent 24%, rgba(0,0,0,0.05) 25%, rgba(0,0,0,0.05) 26%, transparent 27%, transparent 74%, rgba(0,0,0,0.05) 75%, rgba(0,0,0,0.05) 76%, transparent 77%, transparent);
            background-size: 20px 20px;
        }

        .canvas.locked {
            border-color: var(--success);
            box-shadow: 0 0 0 3px rgba(16,185,129,0.2);
        }

        .layout-item {
            position: absolute;
            cursor: move;
            user-select: none;
            /* Hint browser to optimize transform/opacity changes */
            will-change: transform, opacity;
        }

        .layout-item.selected {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        .layout-item.locked {
            cursor: not-allowed;
        }

        .item-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--primary);
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
        .resize-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }

        .lock-indicator {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            background: var(--danger);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            border: 2px solid white;
        }

        /* Right Sidebar - Mobile First */
        .right-sidebar {
            width: 100%;
            background: white;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: none;
            order: 3;
        }

        /* Desktop right sidebar */
        @media (min-width: 992px) {
            .right-sidebar {
                width: 380px;
                border-left: 1px solid var(--border);
                border-top: none;
                box-shadow: -2px 0 8px rgba(0,0,0,0.05);
                height: 100%;
                order: 2;
            }
        }

        .properties-panel {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .property-section {
            margin-bottom: 24px;
        }

        .property-section h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--text);
        }

        .property-field {
            margin-bottom: 16px;
        }

        .property-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text);
        }

        .property-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .property-slider {
            width: 100%;
            transition: all 0.2s ease;
        }

        .property-slider:hover {
            transform: scale(1.02);
        }

        .property-input {
            transition: all 0.2s ease;
        }

        .property-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .color-picker-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .color-swatch {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid var(--border);
            transition: all 0.2s;
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.selected {
            border-color: var(--primary);
            border-width: 3px;
        }

        .code-viewer {
            flex: 1;
            background: #1E293B;
            display: flex;
            flex-direction: column;
        }

        .code-header {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .code-header h3 {
            flex: 1;
            color: white;
            font-size: 16px;
        }

        .code-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #10B981;
        }

        .code-content::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .code-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }

        .code-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 6px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        .code-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.6);
            background-clip: padding-box;
        }

        .code-content::-webkit-scrollbar-corner {
            background: rgba(255, 255, 255, 0.1);
        }

        .code-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748B;
            text-align: center;
            padding: 40px;
        }

        .code-placeholder-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        /* Floating Action Button - Mobile First */
        .fab-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1050;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 28px;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .fab:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
        }

        .fab:active {
            transform: scale(0.95);
        }

        .fab.extended {
            width: auto;
            padding: 16px 24px;
            border-radius: 28px;
            gap: 8px;
            min-width: 56px;
        }

        .fab-label {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Mobile FAB optimizations */
        @media (max-width: 576px) {
            .fab-container {
                bottom: 20px;
                right: 20px;
            }
            
            .fab {
                width: 56px;
                height: 56px;
                font-size: 18px;
            }
            
            .fab.extended {
                padding: 14px 20px;
            }
            
            .fab-label {
                font-size: 13px;
            }
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translateY(0); }
            40%, 43% { transform: translateY(-10px); }
            70% { transform: translateY(-5px); }
            90% { transform: translateY(-2px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Modal */
        /* Responsive Modal System */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 16px;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: calc(100vh - 32px);
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            flex: 1;
            font-size: 1.25rem;
            margin: 0;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        /* Mobile modal optimizations */
        @media (max-width: 576px) {
            .modal {
                padding: 8px;
                align-items: flex-end; /* Bottom sheet style on mobile */
            }
            
            .modal-content {
                border-radius: 16px 16px 0 0;
                max-height: calc(100vh - 16px);
                width: 100%;
                max-width: none;
                margin: 0;
                transform: translateY(100%);
                animation: slideUp 0.3s ease forwards;
            }
            
            .modal-header {
                padding-bottom: 16px;
                margin-bottom: 16px;
            }
            
            .modal-header h2 {
                font-size: 1.1rem;
            }
            
            .modal-actions {
                flex-direction: column-reverse;
                gap: 8px;
            }
            
            .modal-actions .btn {
                width: 100%;
                justify-content: center;
            }
            
            /* Large preview modal adjustments */
            .modal-content[style*="max-width: 1200px"] {
                max-width: none !important;
                height: 100vh !important;
                border-radius: 0;
                padding: 16px;
            }
        }
        
        @keyframes slideUp {
            to {
                transform: translateY(0);
            }
        }

        /* Mobile-first responsive design - No hidden sidebars */
        /* All sections visible and stacked on mobile */
        
        /* Only show sidebar backdrop on very small screens when needed */
        .sidebar-backdrop {
            display: none;
        }

        @media (max-width: 575.98px) {
            /* Only on very small screens, add overlay behavior */
            .sidebar-backdrop {
                position: fixed;
                top: 56px;
                left: 0;
                width: 100vw;
                height: calc(100vh - 56px);
                background: rgba(0, 0, 0, 0.5);
                z-index: 1039;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
                display: block;
            }
            
            .sidebar-backdrop.show {
                opacity: 1;
                visibility: visible;
            }

            .left-sidebar.open, .right-sidebar.open {
                position: fixed;
                top: 56px;
                left: 0;
                width: 100vw;
                height: calc(100vh - 56px);
                z-index: 1040;
                overflow-y: auto;
            }
        }

        /* Mobile phones */
        @media (max-width: 576px) {
            .app-container {
                margin-top: 56px; /* Smaller navbar on mobile */
            }
            
            .navbar {
                height: 56px;
                padding: 0.25rem 0.75rem;
            }
            
            .left-sidebar, .right-sidebar {
                top: 56px;
                height: calc(100vh - 56px);
                width: 100vw; /* Full width on small mobile */
            }
            
            .sidebar-backdrop {
                top: 56px;
                height: calc(100vh - 56px);
            }
            
            .canvas-container {
                padding: 12px;
            }
            
            .canvas-toolbar {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .fab {
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
            }
            
            .fab.extended {
                width: auto;
                padding: 0 20px;
                min-width: 56px;
            }
        }

        /* Canvas mobile optimization */
        @media (max-width: 991.98px) {
            .canvas-container {
                padding: 12px;
                align-items: flex-start;
                min-height: 70vh;
                justify-content: flex-start;
            }
            
            .canvas {
                /* Don't restrict canvas size on mobile - let it be scrollable */
                width: auto;
                max-width: none;
                transform-origin: top left;
                overflow: visible;
            }
            
            .canvas-toolbar {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 8px;
                position: sticky;
                top: 0;
                background: white;
                z-index: 10;
            }
            
            .canvas-info {
                font-size: 14px;
                padding: 8px 12px;
            }
            
            .properties-panel {
                padding: 16px;
                max-height: 60vh;
                overflow-y: auto;
            }
            
            .code-viewer {
                min-height: 300px;
                max-height: 50vh;
            }
            
            /* Larger touch targets for mobile */
            .layout-item {
                min-width: 44px;
                min-height: 44px;
            }
            
            .resize-handle {
                width: 20px;
                height: 20px;
                border-width: 3px;
            }
            
            .resize-handle.nw { top: -10px; left: -10px; }
            .resize-handle.ne { top: -10px; right: -10px; }
            .resize-handle.sw { bottom: -10px; left: -10px; }
            .resize-handle.se { bottom: -10px; right: -10px; }
        }

        /* Extra small phones */
        @media (max-width: 575.98px) {
            .canvas-toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .canvas-info {
                font-size: 12px;
                padding: 6px 12px;
                text-align: center;
            }
            
            .navbar {
                height: 56px;
            }
            
            .app-container {
                margin-top: 56px;
            }
        }

        /* Tooltips */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            background: var(--dark);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-top: 8px;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Bootstrap Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <div class="logo-icon">‚ú®</div>
                <div class="logo-text">
                    <h1>AI UI Designer Pro</h1>
                    <p>Professional Web Design Tool</p>
                </div>
            </a>
            
            <!-- Navbar toggler button -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- Collapsible navbar content - ALL BUTTONS GO HERE -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <!-- Navigation buttons -->
                    <li class="nav-item d-lg-none">
                        <button class="btn btn-outline-primary nav-link" onclick="scrollToSection('leftSidebar')">
                            <i class="bi bi-grid-3x3"></i> Components
                        </button>
                    </li>
                    <li class="nav-item d-lg-none">
                        <button class="btn btn-outline-secondary nav-link" onclick="scrollToSection('rightSidebar')">
                            <i class="bi bi-tools"></i> Properties
                        </button>
                    </li>
                    <!-- Action buttons -->
                    <li class="nav-item">
                        <button class="btn btn-outline-secondary nav-link" data-tooltip="Undo" onclick="undo()">
                            <i class="bi bi-arrow-counterclockwise"></i> Undo
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-secondary nav-link" data-tooltip="Redo" onclick="redo()">
                            <i class="bi bi-arrow-clockwise"></i> Redo
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-info nav-link" id="gridBtn" data-tooltip="Toggle Grid" onclick="toggleGrid()">
                            <i class="bi bi-grid"></i> Grid
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-warning nav-link" data-tooltip="Settings" onclick="showCanvasSettings()">
                            <i class="bi bi-gear"></i> Settings
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-danger nav-link" onclick="clearCanvas()">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- Sidebar backdrop for mobile -->
    <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="closeMobileSidebars()"></div>

    <div class="app-container">
        <!-- Left Sidebar -->
        <aside class="left-sidebar" id="leftSidebar">
            <div class="sidebar-header">
                <h2>üé® Components</h2>
                <p>Professional UI Elements</p>
            </div>
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Search components..." id="searchInput" oninput="filterComponents()">
            </div>
            <div class="component-stats">
                <div class="stat">
                    <div class="stat-value" id="availableCount">0</div>
                    <div class="stat-label">Available</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="canvasCount">0</div>
                    <div class="stat-label">In Canvas</div>
                </div>
            </div>
            <div class="components-list" id="componentsList"></div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="canvas-toolbar">
                <div class="canvas-info" id="canvasInfo">Canvas: 1200√ó800px ‚Ä¢ 0 components</div>
                <div style="flex: 1;"></div>
                <button class="btn btn-primary" id="duplicateBtn" style="display: none;" onclick="duplicateSelected()">üìã Duplicate</button>
                <button class="btn btn-danger" id="deleteBtn" style="display: none;" onclick="deleteSelected()">üóëÔ∏è Delete</button>
                <button class="btn btn-icon" id="lockBtn" style="display: none;" onclick="lockSelected()">üîí</button>
            </div>
            <div class="canvas-container">
                <div class="canvas grid" id="canvas" style="width: 1200px; height: 800px;"></div>
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="right-sidebar" id="rightSidebar">
            <div class="properties-panel" id="propertiesPanel">
                <div style="text-align: center; padding: 40px; color: var(--text-light);">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚öôÔ∏è</div>
                    <p>Select a component to edit its properties</p>
                </div>
            </div>
            <div class="code-viewer">
                <div class="code-header">
                    <h3>üìù Generated Code</h3>
                    <button class="btn btn-success" id="copyCodeBtn" style="display: none;" onclick="copyCode()">üìã Copy</button>
                    <button class="btn btn-primary ms-2" id="previewBtn" style="display: none;" onclick="showPreview()">üîç Preview</button>
                    <button class="btn btn-danger ms-2" id="clearCodeBtn" style="display: none;" onclick="clearCode()">üóëÔ∏è Clear</button>
                </div>
                <div class="code-content" id="codeContent">
                    <div class="code-placeholder">
                        <div class="code-placeholder-icon">üíª</div>
                        <p><strong>Create your design and generate code</strong></p>
                        <p>Add components to the canvas and click "Generate Code"</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- FAB -->
        <div class="fab-container">
            <button class="fab extended" onclick="generateCode()">
                <span id="fabIcon">‚ú®</span>
                <span class="fab-label" id="fabLabel">Generate Code</span>
            </button>
        </div>

        <!-- Modal for Settings -->
        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚öôÔ∏è Canvas Settings</h2>
                    <button class="btn btn-icon" onclick="closeModal('settingsModal')">‚úï</button>
                </div>
                <div class="property-field">
                    <label class="property-label">Width (px)</label>
                    <input type="number" class="property-input" id="canvasWidthInput" value="1200">
                </div>
                <div class="property-field">
                    <label class="property-label">Height (px)</label>
                    <input type="number" class="property-input" id="canvasHeightInput" value="800">
                </div>
                                <div class="property-field">
                                    <label class="property-label">API Key</label>
                                    <input type="text" class="property-input" id="apiKeyInput" placeholder="Enter your Gemini API key">
                                    <small style="color: var(--text-light); display: block; margin-top: 4px;">Get your API key from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></small>
                                </div>
                                <div class="property-field">
                                    <label class="property-label">Model</label>
                                    <input type="text" class="property-input" id="modelInput" placeholder="e.g. gemini-2.0-flash">
                                    <small style="color: var(--text-light); display: block; margin-top: 4px;">Model name used for generation (default: <code>gemini-2.0-flash</code>)</small>
                                </div>
                <div class="modal-actions">
                    <button class="btn btn-icon" onclick="closeModal('settingsModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="applyCanvasSettings()">Apply</button>
                </div>
            </div>
        </div>

        <!-- Modal for Device Templates -->
        <div class="modal" id="templatesModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üì± Device Templates</h2>
                    <button class="btn btn-icon" onclick="closeModal('templatesModal')">‚úï</button>
                </div>
                <div id="templatesList"></div>
            </div>
        </div>
    </div>

        <!-- Preview Modal (shows generated HTML) -->
        <div class="modal" id="previewModal">
            <div class="modal-content" style="max-width: 1200px; width: 95%; height: 85vh;">
                <div class="modal-header">
                    <h2>üîç Preview Generated Code</h2>
                    <button class="btn btn-icon" onclick="closeModal('previewModal')">‚úï</button>
                </div>
                <div style="padding: 12px;">
                    <iframe id="previewFrame" style="width:100%; height:70vh; border:1px solid var(--border); border-radius:8px;" sandbox="allow-same-origin allow-scripts"></iframe>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-icon" onclick="openPreviewInNewTab()">Open in New Tab</button>
                    <button class="btn btn-primary" onclick="closeModal('previewModal')">Close</button>
                </div>
            </div>
        </div>

    <script>
        // Component Library
        const COMPONENTS = [
            { type: 'header', label: 'Header H1', icon: 'üì∞', color: '#3B82F6', size: { width: 240, height: 50 }, text: 'Main Header', tag: 'h1' },
            { type: 'subheader', label: 'Header H2', icon: 'üìù', color: '#6366F1', size: { width: 200, height: 40 }, text: 'Subheader', tag: 'h2' },
            { type: 'h3', label: 'Header H3', icon: 'üìÑ', color: '#8B5CF6', size: { width: 180, height: 35 }, text: 'Section Header', tag: 'h3' },
            { type: 'paragraph', label: 'Paragraph', icon: 'üìÉ', color: '#6B7280', size: { width: 200, height: 60 }, text: 'This is a paragraph of text.', tag: 'p' },
            { type: 'button', label: 'Button', icon: 'üîò', color: '#10B981', size: { width: 120, height: 40 }, text: 'Click Me', tag: 'button' },
            { type: 'input', label: 'Text Input', icon: '‚úèÔ∏è', color: '#F59E0B', size: { width: 220, height: 40 }, text: 'Enter text...', tag: 'input' },
            { type: 'textarea', label: 'Text Area', icon: 'üìã', color: '#EF4444', size: { width: 240, height: 100 }, text: 'Multi-line text...', tag: 'textarea' },
            { type: 'select', label: 'Select Dropdown', icon: 'üîΩ', color: '#8B5CF6', size: { width: 180, height: 40 }, text: 'Choose option', tag: 'select' },
            { type: 'checkbox', label: 'Checkbox', icon: '‚òëÔ∏è', color: '#06B6D4', size: { width: 120, height: 30 }, text: 'Check me', tag: 'input' },
            { type: 'radio', label: 'Radio Button', icon: 'üîò', color: '#F59E0B', size: { width: 120, height: 30 }, text: 'Select option', tag: 'input' },
            { type: 'container', label: 'Container', icon: '‚¨ú', color: '#8B5CF6', size: { width: 200, height: 120 }, text: 'Container', tag: 'div' },
            { type: 'card', label: 'Card', icon: 'üé¥', color: '#A855F7', size: { width: 240, height: 160 }, text: 'Card Component', tag: 'div' },
            { type: 'image', label: 'Image', icon: 'üñºÔ∏è', color: '#06B6D4', size: { width: 160, height: 120 }, text: 'Image', tag: 'img' },
            { type: 'video', label: 'Video', icon: 'üé¨', color: '#EF4444', size: { width: 200, height: 120 }, text: 'Video Player', tag: 'video' },
            { type: 'navbar', label: 'Navigation Bar', icon: '‚ò∞', color: '#1F2937', size: { width: 300, height: 60 }, text: 'Navigation', tag: 'nav' },
            { type: 'link', label: 'Link', icon: 'üîó', color: '#3B82F6', size: { width: 100, height: 25 }, text: 'Click here', tag: 'a' },
            { type: 'list', label: 'Unordered List', icon: '‚Ä¢', color: '#DC2626', size: { width: 180, height: 120 }, text: '‚Ä¢ Item 1\n‚Ä¢ Item 2\n‚Ä¢ Item 3', tag: 'ul' },
            // Modern UI Components
            { type: 'badge', label: 'Badge', icon: 'üè∑Ô∏è', color: '#F59E0B', size: { width: 80, height: 25 }, text: 'New', tag: 'span' },
            { type: 'alert', label: 'Alert Box', icon: '‚ö†Ô∏è', color: '#EF4444', size: { width: 300, height: 60 }, text: 'This is an alert message', tag: 'div' },
            { type: 'progress', label: 'Progress Bar', icon: 'üìä', color: '#10B981', size: { width: 200, height: 20 }, text: '75%', tag: 'div' },
            { type: 'avatar', label: 'Avatar', icon: 'üë§', color: '#6366F1', size: { width: 60, height: 60 }, text: 'JD', tag: 'div' },
            { type: 'tooltip', label: 'Tooltip', icon: 'üí¨', color: '#374151', size: { width: 100, height: 30 }, text: 'Hover me', tag: 'span' },
            { type: 'breadcrumb', label: 'Breadcrumb', icon: 'üß≠', color: '#6B7280', size: { width: 250, height: 30 }, text: 'Home > Page > Current', tag: 'nav' },
            { type: 'modal', label: 'Modal', icon: 'ü™ü', color: '#8B5CF6', size: { width: 400, height: 250 }, text: 'Modal Content', tag: 'div' },
            { type: 'tabs', label: 'Tab Group', icon: 'üìë', color: '#06B6D4', size: { width: 300, height: 200 }, text: 'Tab 1 | Tab 2 | Tab 3', tag: 'div' },
            { type: 'accordion', label: 'Accordion', icon: 'üìã', color: '#A855F7', size: { width: 280, height: 150 }, text: 'Collapsible Section', tag: 'div' },
            { type: 'timeline', label: 'Timeline', icon: '‚è±Ô∏è', color: '#EC4899', size: { width: 200, height: 300 }, text: 'Event Timeline', tag: 'div' },
            { type: 'carousel', label: 'Carousel', icon: 'üé†', color: '#F97316', size: { width: 400, height: 250 }, text: 'Image Carousel', tag: 'div' },
            { type: 'sidebar', label: 'Sidebar', icon: 'üìã', color: '#6366F1', size: { width: 250, height: 400 }, text: 'Sidebar Menu', tag: 'aside' },
            { type: 'footer', label: 'Footer', icon: 'üìÑ', color: '#374151', size: { width: 600, height: 80 }, text: 'Footer Content', tag: 'footer' },
            { type: 'gallery', label: 'Gallery', icon: 'üñºÔ∏è', color: '#059669', size: { width: 400, height: 300 }, text: 'Image Gallery', tag: 'div' },
            { type: 'search', label: 'Search Bar', icon: 'üîç', color: '#0891B2', size: { width: 280, height: 45 }, text: 'Search...', tag: 'div' },
        ];

        // Device Templates
        const DEVICE_TEMPLATES = [
            { name: 'iPhone 14', width: 375, height: 667, icon: 'üì±' },
            { name: 'iPhone 14 Pro', width: 393, height: 852, icon: 'üì±' },
            { name: 'Android Phone', width: 360, height: 640, icon: 'üì±' },
            { name: 'iPad', width: 768, height: 1024, icon: 'üì±' },
            { name: 'Desktop', width: 1200, height: 800, icon: 'üñ•Ô∏è' },
            { name: 'Large Desktop', width: 1440, height: 900, icon: 'üñ•Ô∏è' },
            { name: 'Ultrawide', width: 1920, height: 1080, icon: 'üñ•Ô∏è' },
        ];

        // State
        let layoutItems = [];
        let selectedItem = null;
        let canvasWidth = 1200;
        let canvasHeight = 800;
        let showGrid = true;
        let canvasLocked = false;
        let history = [];
        let historyIndex = -1;
    let draggedItem = null;
    let dragOffset = { x: 0, y: 0 };
    let resizing = null;
    // Cache of DOM elements for layout items keyed by item.id to minimize DOM churn
    const elementCache = new Map();
    
    // API Key Management
    let apiKey = '';
    
    // For Vercel deployment with public environment variable
    // Environment variables with NEXT_PUBLIC_ prefix are available in client-side code
    // But since this is a static HTML file, we'll use a different approach
    
    // Option 1: Check for runtime config (if you add a config endpoint)
    // Option 2: Use localStorage as primary method for now
    const savedKey = localStorage.getItem('geminiApiKey');
    if (savedKey) {
        apiKey = savedKey;
    }
    
    // Default model. Using Gemini 2.0 Flash as requested.
    // You can change this in Canvas Settings (Model field) or set localStorage key 'geminiModel'.
    let modelName = 'gemini-2.0-flash';

        // Rendering scheduler to batch DOM updates and avoid excessive reflows.
        let renderScheduled = false;
        function scheduleRender() {
            if (renderScheduled) return;
            renderScheduled = true;
            requestAnimationFrame(() => {
                renderScheduled = false;
                renderCanvas();
                // lightweight UI updates
                updateCanvasInfo();
                updateStats();
            });
        }

        // Debounce helper for input-heavy handlers
        function debounce(fn, wait) {
            let t = null;
            return function(...args) {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        // Mobile canvas optimization - simplified
        function adjustCanvasForMobile() {
            const canvas = document.getElementById('canvas');
            if (!canvas) return;
            
            // Remove any scaling transforms - let canvas be naturally sized and scrollable
            canvas.style.transform = '';
            canvas.classList.remove('mobile-scaled');
        }

        // Initialize
        function init() {
            renderComponents();
            updateStats();
            setupEventListeners();
            loadApiKey();
            saveHistory();
            
            // Initialize grid toggle state
            const gridBtn = document.getElementById('gridBtn');
            if (showGrid) {
                gridBtn.classList.add('active');
                document.getElementById('canvas').classList.add('grid');
            }
            
            // Adjust canvas for mobile on load
            adjustCanvasForMobile();
            
            // Readjust on window resize
            let adjustTimer;
            window.addEventListener('resize', () => {
                clearTimeout(adjustTimer);
                adjustTimer = setTimeout(adjustCanvasForMobile, 150);
            });
        }

        // Load API key from localStorage or fetch from server
        async function loadApiKey() {
            // First try to get API key from your server endpoint
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const config = await response.json();
                    if (config.apiKey) {
                        apiKey = config.apiKey;
                        console.log('‚úÖ Using API key from server configuration');
                        document.getElementById('apiKeyInput').placeholder = '‚úÖ API key loaded from server';
                        document.getElementById('apiKeyInput').value = '';
                        return;
                    }
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è No server config endpoint found, using localStorage');
            }

            // Fallback to localStorage
            const saved = localStorage.getItem('geminiApiKey');
            if (saved) {
                apiKey = saved;
                document.getElementById('apiKeyInput').value = saved;
                console.log('‚úÖ Using API key from localStorage');
            } else {
                console.log('‚ö†Ô∏è No API key found. Please enter your Gemini API key in Canvas Settings.');
            }
            
            // Load saved model if present
            const savedModel = localStorage.getItem('geminiModel');
            if (savedModel) {
                modelName = savedModel;
                const mi = document.getElementById('modelInput');
                if (mi) mi.value = modelName;
            } else {
                // populate model input with default
                const mi = document.getElementById('modelInput');
                if (mi) mi.value = modelName;
            }
        }

        // Render Components List
        function renderComponents() {
            const list = document.getElementById('componentsList');
            list.innerHTML = '';
            
            COMPONENTS.forEach(component => {
                const item = document.createElement('div');
                item.className = 'component-item';
                item.innerHTML = `
                    <div class="component-icon" style="background: ${component.color}">${component.icon}</div>
                    <div class="component-info">
                        <div class="component-label">${component.label}</div>
                        <div class="component-type">${component.type}</div>
                    </div>
                `;
                item.addEventListener('dblclick', () => addComponent(component));
                list.appendChild(item);
            });
        }

        // Filter Components (debounced to avoid frequent DOM updates while typing)
        let _filterTimer = null;
        function filterComponents() {
            clearTimeout(_filterTimer);
            _filterTimer = setTimeout(() => {
                const query = document.getElementById('searchInput').value.toLowerCase();
                const items = document.querySelectorAll('.component-item');

                items.forEach((item, index) => {
                    const component = COMPONENTS[index];
                    const matches = component.label.toLowerCase().includes(query) || 
                                  component.type.toLowerCase().includes(query);
                    item.style.display = matches ? 'flex' : 'none';
                });
            }, 120);
        }

        // Add Component to Canvas
        function addComponent(component) {
            const item = {
                id: Date.now().toString(),
                component: component,
                x: 50 + (layoutItems.length * 25),
                y: 50 + (layoutItems.length * 25),
                width: component.size.width,
                height: component.size.height,
                text: component.text,
                bgColor: '#FFFFFF',
                textColor: '#000000',
                fontSize: 16,
                borderRadius: 8,
                opacity: 1,
                rotation: 0,
                locked: false,
                visible: true,
                // Modern properties
                shadowX: 0,
                shadowY: 2,
                shadowBlur: 4,
                shadowColor: '#00000020',
                borderWidth: 0,
                borderColor: '#E5E7EB',
                borderStyle: 'solid',
                gradientFrom: '',
                gradientTo: '',
                gradientDirection: '135deg',
                animation: 'none',
                zIndex: 1,
                // Advanced layout properties
                margin: 0,
                padding: 8,
                // Typography
                fontWeight: 'normal',
                fontStyle: 'normal',
                textAlign: 'center',
                lineHeight: 1.4,
                letterSpacing: 0,
                textDecoration: 'none',
                // Effects
                filter: 'none',
                backdrop: 'none',
                cursor: 'default'
            };
            
            layoutItems.push(item);
            renderCanvas();
            selectItem(item);
            updateStats();
            saveHistory();
        }

        // Render Canvas
        // Render Canvas ‚Äî reuses DOM elements when possible to minimize churn.
        function renderCanvas() {
            const canvas = document.getElementById('canvas');

            // Track which ids are still present
            const presentIds = new Set();

            layoutItems.forEach(item => {
                if (!item.visible) return;
                presentIds.add(item.id);

                let element = elementCache.get(item.id);
                const isSelected = selectedItem?.id === item.id;

                if (!element) {
                    // Create element once and store in cache
                    element = document.createElement('div');
                    element.className = 'layout-item';
                    element.style.touchAction = 'none'; // allow pointer dragging on touch devices

                    const content = document.createElement('div');
                    content.className = 'item-content';
                    element.appendChild(content);

                    element.addEventListener('click', (e) => {
                        e.stopPropagation();
                        selectItem(item);
                    });

                    // Use pointerdown for broad device support
                    element.addEventListener('pointerdown', (e) => {
                        if (item.locked) return;
                        if (e.target.classList.contains('resize-handle')) {
                            startResize(item, e);
                        } else {
                            startDrag(item, e);
                        }
                    });

                    elementCache.set(item.id, element);
                    canvas.appendChild(element);
                }

                // Update classes
                element.className = 'layout-item' + (isSelected ? ' selected' : '') + (item.locked ? ' locked' : '');

                // Update size, opacity and transform (use transform for position)
                element.style.width = item.width + 'px';
                element.style.height = item.height + 'px';
                element.style.opacity = item.opacity;
                element.style.transform = `translate(${item.x}px, ${item.y}px) rotate(${item.rotation}deg)`;

                // Update content
                const content = element.querySelector('.item-content');
                
                // Background and gradient styling
                let backgroundStyle = item.bgColor;
                if (item.gradientFrom && item.gradientTo) {
                    backgroundStyle = `linear-gradient(${item.gradientDirection || '135deg'}, ${item.gradientFrom}, ${item.gradientTo})`;
                }
                content.style.background = backgroundStyle;
                
                // Typography
                content.style.color = item.textColor;
                content.style.fontSize = item.fontSize + 'px';
                content.style.fontWeight = item.fontWeight || 'normal';
                content.style.textAlign = item.textAlign || 'center';
                content.style.lineHeight = item.lineHeight || 1.4;
                content.style.letterSpacing = (item.letterSpacing || 0) + 'px';
                
                // Border and spacing
                content.style.borderRadius = item.borderRadius + 'px';
                content.style.padding = (item.padding || 8) + 'px';
                content.style.margin = (item.margin || 0) + 'px';
                
                // Border styling
                if (item.borderWidth > 0) {
                    content.style.border = `${item.borderWidth}px ${item.borderStyle || 'solid'} ${item.borderColor}`;
                } else {
                    content.style.border = 'none';
                }

                // Shadow effects
                let boxShadow = 'none';
                if (item.shadowBlur > 0) {
                    boxShadow = `${item.shadowX}px ${item.shadowY}px ${item.shadowBlur}px ${item.shadowColor}`;
                }
                content.style.boxShadow = boxShadow;
                
                // Filter effects
                content.style.filter = item.filter || 'none';
                
                // Animation
                if (item.animation !== 'none') {
                    content.style.animation = item.animation;
                } else {
                    content.style.animation = '';
                }
                
                // Cursor
                content.style.cursor = item.cursor || 'default';
                
                // Z-index
                element.style.zIndex = item.zIndex;

                // Apply visual variants
                switch (item.component.type) {
                    case 'button':
                        content.style.background = backgroundStyle === item.bgColor ? '#6366F1' : backgroundStyle;
                        content.style.color = 'white';
                        content.style.fontWeight = '600';
                        content.style.cursor = 'pointer';
                        content.style.textAlign = 'center';
                        if (!item.shadowBlur) content.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                        break;
                    case 'input':
                    case 'textarea':
                        content.style.border = item.borderWidth > 0 ? content.style.border : '1px solid #D1D5DB';
                        content.style.background = backgroundStyle === item.bgColor ? '#FFFFFF' : backgroundStyle;
                        break;
                    case 'navbar':
                        content.style.background = backgroundStyle === item.bgColor ? '#1F2937' : backgroundStyle;
                        content.style.color = 'white';
                        break;
                    case 'badge':
                        content.style.background = backgroundStyle === item.bgColor ? '#F59E0B' : backgroundStyle;
                        content.style.color = 'white';
                        content.style.fontSize = '12px';
                        content.style.fontWeight = '600';
                        content.style.textAlign = 'center';
                        content.style.borderRadius = '12px';
                        if (!item.shadowBlur) content.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';
                        break;
                    case 'alert':
                        content.style.background = backgroundStyle === item.bgColor ? '#FEF2F2' : backgroundStyle;
                        content.style.border = item.borderWidth > 0 ? content.style.border : '1px solid #FECACA';
                        content.style.color = '#DC2626';
                        content.style.padding = '12px';
                        break;
                    case 'progress':
                        content.style.background = '#E5E7EB';
                        content.style.borderRadius = '10px';
                        content.style.overflow = 'hidden';
                        content.innerHTML = `<div style="width:75%; height:100%; background:${backgroundStyle === item.bgColor ? '#10B981' : backgroundStyle}; transition:width 0.3s;"></div>`;
                        break;
                    case 'avatar':
                        content.style.background = backgroundStyle === item.bgColor ? '#6366F1' : backgroundStyle;
                        content.style.color = 'white';
                        content.style.borderRadius = '50%';
                        content.style.fontWeight = '600';
                        content.style.textAlign = 'center';
                        if (!item.shadowBlur) content.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                        break;
                    case 'card':
                        content.style.background = backgroundStyle === item.bgColor ? 'white' : backgroundStyle;
                        content.style.border = item.borderWidth > 0 ? content.style.border : '1px solid #E5E7EB';
                        content.style.borderRadius = '8px';
                        content.style.padding = '16px';
                        if (!item.shadowBlur) content.style.boxShadow = '0 4px 6px rgba(0,0,0,0.07)';
                        break;
                    case 'modal':
                        content.style.background = backgroundStyle === item.bgColor ? 'white' : backgroundStyle;
                        content.style.border = item.borderWidth > 0 ? content.style.border : '1px solid #E5E7EB';
                        content.style.borderRadius = '12px';
                        content.style.padding = '24px';
                        if (!item.shadowBlur) content.style.boxShadow = '0 20px 25px rgba(0,0,0,0.15)';
                        break;
                    case 'carousel':
                        content.style.background = backgroundStyle === item.bgColor ? '#F3F4F6' : backgroundStyle;
                        content.style.border = '1px solid #E5E7EB';
                        content.style.borderRadius = '8px';
                        content.style.position = 'relative';
                        content.style.overflow = 'hidden';
                        break;
                    case 'sidebar':
                        content.style.background = backgroundStyle === item.bgColor ? '#F9FAFB' : backgroundStyle;
                        content.style.borderRight = '1px solid #E5E7EB';
                        content.style.padding = '20px 16px';
                        content.style.alignItems = 'flex-start';
                        content.style.justifyContent = 'flex-start';
                        break;
                    case 'footer':
                        content.style.background = backgroundStyle === item.bgColor ? '#374151' : backgroundStyle;
                        content.style.color = item.textColor === '#000000' ? 'white' : item.textColor;
                        content.style.padding = '20px';
                        break;
                    case 'gallery':
                        content.style.background = backgroundStyle === item.bgColor ? '#F3F4F6' : backgroundStyle;
                        content.style.border = '2px dashed #D1D5DB';
                        content.style.borderRadius = '8px';
                        content.style.position = 'relative';
                        break;
                    case 'search':
                        content.style.background = backgroundStyle === item.bgColor ? 'white' : backgroundStyle;
                        content.style.border = item.borderWidth > 0 ? content.style.border : '2px solid #E5E7EB';
                        content.style.borderRadius = '24px';
                        content.style.padding = '12px 20px';
                        content.style.display = 'flex';
                        content.style.alignItems = 'center';
                        break;
                    default:
                        // Apply custom styling for other components
                        content.style.background = backgroundStyle;
                        content.style.cursor = '';
                }

                content.textContent = item.text;

                // Lock indicator
                let lock = element.querySelector('.lock-indicator');
                if (item.locked) {
                    if (!lock) {
                        lock = document.createElement('div');
                        lock.className = 'lock-indicator';
                        lock.innerHTML = 'üîí';
                        element.appendChild(lock);
                    }
                } else if (lock) {
                    lock.remove();
                }

                // Resize handles for selected item
                if (isSelected && !item.locked) {
                    // ensure handles exist
                    const existingHandles = element.querySelectorAll('.resize-handle');
                    if (existingHandles.length === 0) {
                        ['nw', 'ne', 'sw', 'se'].forEach(pos => {
                            const handle = document.createElement('div');
                            handle.className = `resize-handle ${pos}`;
                            handle.dataset.position = pos;
                            // pointerdown on handle should start resize
                            handle.addEventListener('pointerdown', (ev) => {
                                ev.stopPropagation();
                                startResize(item, ev);
                            });
                            element.appendChild(handle);
                        });
                    }
                } else {
                    // remove any handles if present
                    const existingHandles = element.querySelectorAll('.resize-handle');
                    existingHandles.forEach(h => h.remove());
                }
            });

            // Remove cached elements that are no longer present
            for (const [id, el] of elementCache.entries()) {
                if (!presentIds.has(id)) {
                    if (el.parentNode) el.parentNode.removeChild(el);
                    elementCache.delete(id);
                }
            }

            updateCanvasInfo();
        }

        // Start Dragging
        function startDrag(item, e) {
            if (item.locked) return;
            draggedItem = item;
            const canvas = document.getElementById('canvas');
            const canvasRect = canvas.getBoundingClientRect();
            // Calculate offset relative to canvas so dragging stays accurate on different devices
            dragOffset.x = e.clientX - canvasRect.left - item.x;
            dragOffset.y = e.clientY - canvasRect.top - item.y;
            // Capture the pointer so we keep receiving pointer events even if leaving the element
            if (e.pointerId && e.target.setPointerCapture) {
                try { e.target.setPointerCapture(e.pointerId); } catch (err) { /* ignore */ }
            }
        }

        // Start Resizing
        function startResize(item, e) {
            if (item.locked) return;
            e.stopPropagation();
            resizing = {
                item: item,
                position: e.target.dataset.position,
                startX: e.clientX,
                startY: e.clientY,
                startWidth: item.width,
                startHeight: item.height,
                startItemX: item.x,
                startItemY: item.y
            };
        }

        // Setup Event Listeners
        function setupEventListeners() {
            const canvas = document.getElementById('canvas');
            
            // Canvas click to deselect
            canvas.addEventListener('click', () => {
                if (!draggedItem && !resizing) {
                    selectedItem = null;
                    renderCanvas();
                    renderProperties();
                }
            });

            // Mobile-specific touch improvements
            // Prevent default touch behaviors on canvas to improve touch handling
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // Prevent scrolling when touching canvas
            }, { passive: false });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault(); // Prevent scrolling during drag
            }, { passive: false });

            // Close mobile overlays when touching canvas (only on very small screens)
            canvas.addEventListener('pointerdown', () => {
                if (window.innerWidth <= 575) {
                    closeMobileSidebars();
                }
            });

            // Handle escape key to close mobile overlays
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && window.innerWidth <= 575) {
                    closeMobileSidebars();
                }
            });

            // Handle window resize to close overlays when screen gets larger
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    if (window.innerWidth > 575) {
                        // Remove overlay states when screen gets larger
                        const left = document.getElementById('leftSidebar');
                        const right = document.getElementById('rightSidebar');
                        const backdrop = document.getElementById('sidebarBackdrop');
                        
                        if (left) left.classList.remove('open');
                        if (right) right.classList.remove('open');
                        if (backdrop) backdrop.classList.remove('show');
                        document.body.style.overflow = '';
                    }
                }, 150);
            });
            
            // Pointer move for drag and resize. Using pointer events improves touch support.
            document.addEventListener('pointermove', (e) => {
                if (draggedItem) {
                    const canvasRect = canvas.getBoundingClientRect();
                    let newX = e.clientX - canvasRect.left - dragOffset.x;
                    let newY = e.clientY - canvasRect.top - dragOffset.y;

                    // Constrain to canvas
                    newX = Math.max(0, Math.min(newX, canvasWidth - draggedItem.width));
                    newY = Math.max(0, Math.min(newY, canvasHeight - draggedItem.height));

                    draggedItem.x = newX;
                    draggedItem.y = newY;

                    // Update the DOM element transform immediately for smooth dragging
                    const el = elementCache.get(draggedItem.id);
                    if (el) {
                        el.style.transform = `translate(${draggedItem.x}px, ${draggedItem.y}px) rotate(${draggedItem.rotation}deg)`;
                    } else {
                        scheduleRender();
                    }
                }

                if (resizing) {
                    const deltaX = e.clientX - resizing.startX;
                    const deltaY = e.clientY - resizing.startY;
                    const pos = resizing.position;

                    if (pos.includes('e')) {
                        resizing.item.width = Math.max(30, resizing.startWidth + deltaX);
                    }
                    if (pos.includes('w')) {
                        const newWidth = Math.max(30, resizing.startWidth - deltaX);
                        resizing.item.x = resizing.startItemX + (resizing.startWidth - newWidth);
                        resizing.item.width = newWidth;
                    }
                    if (pos.includes('s')) {
                        resizing.item.height = Math.max(30, resizing.startHeight + deltaY);
                    }
                    if (pos.includes('n')) {
                        const newHeight = Math.max(30, resizing.startHeight - deltaY);
                        resizing.item.y = resizing.startItemY + (resizing.startHeight - newHeight);
                        resizing.item.height = newHeight;
                    }

                    // Update element directly when possible
                    const rEl = elementCache.get(resizing.item.id);
                    if (rEl) {
                        rEl.style.width = resizing.item.width + 'px';
                        rEl.style.height = resizing.item.height + 'px';
                        rEl.style.transform = `translate(${resizing.item.x}px, ${resizing.item.y}px) rotate(${resizing.item.rotation}deg)`;
                    } else {
                        scheduleRender();
                    }
                }
            });
            
            // Pointer up to stop drag/resize
            document.addEventListener('pointerup', (e) => {
                if (draggedItem || resizing) {
                    saveHistory();
                }
                // Release pointer capture if possible
                try {
                    if (e.pointerId && document.releasePointerCapture) {
                        document.releasePointerCapture(e.pointerId);
                    }
                } catch (err) { /* ignore */ }
                draggedItem = null;
                resizing = null;
                // Ensure final render to sync any remaining visual state
                scheduleRender();
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'z') {
                        e.preventDefault();
                        undo();
                    } else if (e.key === 'y') {
                        e.preventDefault();
                        redo();
                    } else if (e.key === 'l') {
                        e.preventDefault();
                        toggleCanvasLock();
                    } else if (e.key === 'd') {
                        e.preventDefault();
                        duplicateSelected();
                    }
                }
                
                if (e.key === 'Delete' && selectedItem) {
                    deleteSelected();
                }
            });
        }

        // Select Item
        function selectItem(item) {
            selectedItem = item;
            renderCanvas();
            renderProperties();
            
            // Show/hide toolbar buttons
            document.getElementById('duplicateBtn').style.display = 'block';
            document.getElementById('deleteBtn').style.display = 'block';
            document.getElementById('lockBtn').style.display = 'block';
        }

        // Render Properties Panel
        function renderProperties() {
            const panel = document.getElementById('propertiesPanel');
            
            if (!selectedItem) {
                panel.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚öôÔ∏è</div>
                        <p>Select a component to edit its properties</p>
                    </div>
                `;
                return;
            }
            
            panel.innerHTML = `
                <div class="property-section">
                    <h3>üìè Layout & Position</h3>
                    <div class="property-field">
                        <label class="property-label">X Position: ${Math.round(selectedItem.x)}px</label>
                        <input type="range" class="property-slider" min="0" max="${canvasWidth - selectedItem.width}" value="${selectedItem.x}" oninput="updateProperty('x', parseFloat(this.value))">
                    </div>
                    <div class="property-field">
                        <label class="property-label">Y Position: ${Math.round(selectedItem.y)}px</label>
                        <input type="range" class="property-slider" min="0" max="${canvasHeight - selectedItem.height}" value="${selectedItem.y}" oninput="updateProperty('y', parseFloat(this.value))">
                    </div>
                    <div class="property-field">
                        <label class="property-label">Width: ${Math.round(selectedItem.width)}px</label>
                        <input type="range" class="property-slider" min="30" max="${canvasWidth}" value="${selectedItem.width}" oninput="updateProperty('width', parseFloat(this.value))">
                    </div>
                    <div class="property-field">
                        <label class="property-label">Height: ${Math.round(selectedItem.height)}px</label>
                        <input type="range" class="property-slider" min="30" max="${canvasHeight}" value="${selectedItem.height}" oninput="updateProperty('height', parseFloat(this.value))">
                    </div>
                    <div class="property-field">
                        <label class="property-label">Z-Index: ${selectedItem.zIndex}</label>
                        <input type="range" class="property-slider" min="1" max="100" value="${selectedItem.zIndex}" oninput="updateProperty('zIndex', parseFloat(this.value))">
                    </div>
                    <div class="property-field">
                        <label class="property-label">Rotation: ${Math.round(selectedItem.rotation)}¬∞</label>
                        <input type="range" class="property-slider" min="0" max="360" value="${selectedItem.rotation}" oninput="updateProperty('rotation', parseFloat(this.value))">
                    </div>
                    <div class="property-field">
                        <label class="property-label">Opacity: ${selectedItem.opacity.toFixed(2)}</label>
                        <input type="range" class="property-slider" min="0" max="1" step="0.01" value="${selectedItem.opacity}" oninput="updateProperty('opacity', parseFloat(this.value))">
                    </div>
                </div>

                <div class="property-section">
                    <h3>üé® Colors & Background</h3>
                    <div class="property-field">
                        <label class="property-label">Background Color</label>
                        <input type="color" class="property-input" value="${selectedItem.bgColor}" onchange="updateProperty('bgColor', this.value)">
                        <div class="color-picker-grid" style="margin-top: 8px;">
                            ${['#FFFFFF', '#F3F4F6', '#E5E7EB', '#000000', '#1F2937', '#EF4444', '#F59E0B', '#10B981', '#06B6D4', '#3B82F6', '#6366F1', '#8B5CF6', '#A855F7', '#EC4899', '#F97316'].map(color => 
                                `<div class="color-swatch ${selectedItem.bgColor === color ? 'selected' : ''}" style="background: ${color}" onclick="updateProperty('bgColor', '${color}')"></div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="property-field">
                        <label class="property-label">Text Color</label>
                        <input type="color" class="property-input" value="${selectedItem.textColor}" onchange="updateProperty('textColor', this.value)">
                        <div class="color-picker-grid" style="margin-top: 8px;">
                            ${['#000000', '#1F2937', '#6B7280', '#FFFFFF', '#EF4444', '#F59E0B', '#10B981', '#06B6D4', '#3B82F6', '#6366F1', '#8B5CF6', '#A855F7', '#EC4899', '#DC2626', '#F97316'].map(color => 
                                `<div class="color-swatch ${selectedItem.textColor === color ? 'selected' : ''}" style="background: ${color}" onclick="updateProperty('textColor', '${color}')"></div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="property-field">
                        <label class="property-label">Gradient From</label>
                        <input type="color" class="property-input" value="${selectedItem.gradientFrom || '#6366F1'}" onchange="updateProperty('gradientFrom', this.value)">
                    </div>
                    <div class="property-field">
                        <label class="property-label">Gradient To</label>
                        <input type="color" class="property-input" value="${selectedItem.gradientTo || '#8B5CF6'}" onchange="updateProperty('gradientTo', this.value)">
                    </div>
                    <div class="property-field">
                        <label class="property-label">Gradient Direction</label>
                        <select class="property-input" onchange="updateProperty('gradientDirection', this.value)">
                            <option value="135deg" ${selectedItem.gradientDirection === '135deg' ? 'selected' : ''}>Diagonal ‚Üò</option>
                            <option value="90deg" ${selectedItem.gradientDirection === '90deg' ? 'selected' : ''}>Vertical ‚Üì</option>
                            <option value="0deg" ${selectedItem.gradientDirection === '0deg' ? 'selected' : ''}>Horizontal ‚Üí</option>
                            <option value="45deg" ${selectedItem.gradientDirection === '45deg' ? 'selected' : ''}>Diagonal ‚Üó</option>
                            <option value="180deg" ${selectedItem.gradientDirection === '180deg' ? 'selected' : ''}>Horizontal ‚Üê</option>
                            <option value="270deg" ${selectedItem.gradientDirection === '270deg' ? 'selected' : ''}>Vertical ‚Üë</option>
                        </select>
                    </div>
                </div>

                <div class="property-section">
                    <h3>‚úçÔ∏è Typography & Content</h3>
                    <div class="property-field">
                        <label class="property-label">Content</label>
                        <textarea class="property-input" rows="3" onchange="updateProperty('text', this.value)">${selectedItem.text}</textarea>
                    </div>
                    <div class="property-field">
                        <label class="property-label">Font Size: ${Math.round(selectedItem.fontSize)}px</label>
                        <input type="range" class="property-slider" min="8" max="72" value="${selectedItem.fontSize}" oninput="updateProperty('fontSize', parseFloat(this.value))">
                    </div>
                    <div class="property-field">
                        <label class="property-label">Font Weight</label>
                        <select class="property-input" onchange="updateProperty('fontWeight', this.value)">
                            <option value="normal" ${selectedItem.fontWeight === 'normal' ? 'selected' : ''}>Normal</option>
                            <option value="bold" ${selectedItem.fontWeight === 'bold' ? 'selected' : ''}>Bold</option>
                            <option value="lighter" ${selectedItem.fontWeight === 'lighter' ? 'selected' : ''}>Lighter</option>
                            <option value="bolder" ${selectedItem.fontWeight === 'bolder' ? 'selected' : ''}>Bolder</option>
                        </select>
                    </div>
                    <div class="property-field">
                        <label class="property-label">Text Align</label>
                        <select class="property-input" onchange="updateProperty('textAlign', this.value)">
                            <option value="left" ${selectedItem.textAlign === 'left' ? 'selected' : ''}>Left</option>
                            <option value="center" ${selectedItem.textAlign === 'center' ? 'selected' : ''}>Center</option>
                            <option value="right" ${selectedItem.textAlign === 'right' ? 'selected' : ''}>Right</option>
                            <option value="justify" ${selectedItem.textAlign === 'justify' ? 'selected' : ''}>Justify</option>
                        </select>
                    </div>
                    <div class="property-field">
                        <label class="property-label">Line Height: ${selectedItem.lineHeight}</label>
                        <input type="range" class="property-slider" min="0.8" max="3" step="0.1" value="${selectedItem.lineHeight}" oninput="updateProperty('lineHeight', parseFloat(this.value))">
                    </div>
                </div>

                <div class="property-section">
                    <h3>üî≤ Border & Spacing</h3>
                    <div class="property-field">
                        <label class="property-label">Border Width: ${selectedItem.borderWidth}px</label>
                        <input type="range" class="property-slider" min="0" max="20" value="${selectedItem.borderWidth}" oninput="updateProperty('borderWidth', parseFloat(this.value))">
                    </div>
                    <div class="property-field">
                        <label class="property-label">Border Color</label>
                        <input type="color" class="property-input" value="${selectedItem.borderColor}" onchange="updateProperty('borderColor', this.value)">
                    </div>
                    <div class="property-field">
                        <label class="property-label">Border Style</label>
                        <select class="property-input" onchange="updateProperty('borderStyle', this.value)">
                            <option value="solid" ${selectedItem.borderStyle === 'solid' ? 'selected' : ''}>Solid</option>
                            <option value="dashed" ${selectedItem.borderStyle === 'dashed' ? 'selected' : ''}>Dashed</option>
                            <option value="dotted" ${selectedItem.borderStyle === 'dotted' ? 'selected' : ''}>Dotted</option>
                            <option value="double" ${selectedItem.borderStyle === 'double' ? 'selected' : ''}>Double</option>
                        </select>
                    </div>
                    <div class="property-field">
                        <label class="property-label">Border Radius: ${Math.round(selectedItem.borderRadius)}px</label>
                        <input type="range" class="property-slider" min="0" max="100" value="${selectedItem.borderRadius}" oninput="updateProperty('borderRadius', parseFloat(this.value))">
                    </div>
                    <div class="property-field">
                        <label class="property-label">Padding: ${selectedItem.padding}px</label>
                        <input type="range" class="property-slider" min="0" max="50" value="${selectedItem.padding}" oninput="updateProperty('padding', parseFloat(this.value))">
                    </div>
                </div>

                <div class="property-section">
                    <h3>‚ú® Shadow & Effects</h3>
                    <div class="property-field">
                        <label class="property-label">Shadow X: ${selectedItem.shadowX}px</label>
                        <input type="range" class="property-slider" min="-20" max="20" value="${selectedItem.shadowX}" oninput="updateProperty('shadowX', parseFloat(this.value))">
                    </div>
                    <div class="property-field">
                        <label class="property-label">Shadow Y: ${selectedItem.shadowY}px</label>
                        <input type="range" class="property-slider" min="-20" max="20" value="${selectedItem.shadowY}" oninput="updateProperty('shadowY', parseFloat(this.value))">
                    </div>
                    <div class="property-field">
                        <label class="property-label">Shadow Blur: ${selectedItem.shadowBlur}px</label>
                        <input type="range" class="property-slider" min="0" max="50" value="${selectedItem.shadowBlur}" oninput="updateProperty('shadowBlur', parseFloat(this.value))">
                    </div>
                    <div class="property-field">
                        <label class="property-label">Filter Effects</label>
                        <select class="property-input" onchange="updateProperty('filter', this.value)">
                            <option value="none" ${selectedItem.filter === 'none' ? 'selected' : ''}>None</option>
                            <option value="blur(2px)" ${selectedItem.filter === 'blur(2px)' ? 'selected' : ''}>Blur</option>
                            <option value="brightness(1.2)" ${selectedItem.filter === 'brightness(1.2)' ? 'selected' : ''}>Bright</option>
                            <option value="contrast(1.2)" ${selectedItem.filter === 'contrast(1.2)' ? 'selected' : ''}>Contrast</option>
                            <option value="grayscale(1)" ${selectedItem.filter === 'grayscale(1)' ? 'selected' : ''}>Grayscale</option>
                            <option value="sepia(1)" ${selectedItem.filter === 'sepia(1)' ? 'selected' : ''}>Sepia</option>
                        </select>
                    </div>
                </div>

                <div class="property-section">
                    <h3>üé¨ Animation & Behavior</h3>
                    <div class="property-field">
                        <label class="property-label">Animation</label>
                        <select class="property-input" onchange="updateProperty('animation', this.value)">
                            <option value="none" ${selectedItem.animation === 'none' ? 'selected' : ''}>None</option>
                            <option value="pulse 2s infinite" ${selectedItem.animation === 'pulse 2s infinite' ? 'selected' : ''}>Pulse</option>
                            <option value="bounce 2s infinite" ${selectedItem.animation === 'bounce 2s infinite' ? 'selected' : ''}>Bounce</option>
                            <option value="fadeIn 1s ease-in" ${selectedItem.animation === 'fadeIn 1s ease-in' ? 'selected' : ''}>Fade In</option>
                            <option value="slideInUp 1s ease-out" ${selectedItem.animation === 'slideInUp 1s ease-out' ? 'selected' : ''}>Slide Up</option>
                        </select>
                    </div>
                    <div class="property-field">
                        <label class="property-label">Cursor Style</label>
                        <select class="property-input" onchange="updateProperty('cursor', this.value)">
                            <option value="default" ${selectedItem.cursor === 'default' ? 'selected' : ''}>Default</option>
                            <option value="pointer" ${selectedItem.cursor === 'pointer' ? 'selected' : ''}>Pointer</option>
                            <option value="text" ${selectedItem.cursor === 'text' ? 'selected' : ''}>Text</option>
                            <option value="move" ${selectedItem.cursor === 'move' ? 'selected' : ''}>Move</option>
                        </select>
                    </div>
                </div>

                <div class="property-section">
                    <h3>üîí State & Visibility</h3>
                    <div class="property-field">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" ${selectedItem.locked ? 'checked' : ''} onchange="updateProperty('locked', this.checked)">
                            <span>Locked</span>
                        </label>
                    </div>
                    <div class="property-field">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" ${selectedItem.visible ? 'checked' : ''} onchange="updateProperty('visible', this.checked)">
                            <span>Visible</span>
                        </label>
                    </div>
                </div>
            `;
        }

    // Debounced properties renderer to avoid rebuilding the panel too frequently
    const debouncedRenderProperties = debounce(renderProperties, 60);

        // Update Property
        function updateProperty(key, value) {
            if (selectedItem) {
                selectedItem[key] = value;
                // Batch canvas renders via rAF and throttle properties panel rebuilds
                scheduleRender();
                debouncedRenderProperties();
            }
        }

        // Duplicate Selected
        function duplicateSelected() {
            if (selectedItem) {
                const newItem = {
                    ...selectedItem,
                    id: Date.now().toString(),
                    x: selectedItem.x + 20,
                    y: selectedItem.y + 20
                };
                layoutItems.push(newItem);
                selectItem(newItem);
                saveHistory();
            }
        }

        // Delete Selected
        function deleteSelected() {
            if (selectedItem && !selectedItem.locked) {
                layoutItems = layoutItems.filter(item => item.id !== selectedItem.id);
                selectedItem = null;
                renderCanvas();
                renderProperties();
                updateStats();
                saveHistory();
            }
        }

        // Lock Selected
        function lockSelected() {
            if (selectedItem) {
                selectedItem.locked = !selectedItem.locked;
                renderCanvas();
            }
        }

        // Toggle Canvas Lock
        function toggleCanvasLock() {
            canvasLocked = !canvasLocked;
            const canvas = document.getElementById('canvas');
            const btn = document.getElementById('canvasLockBtn');
            
            if (canvasLocked) {
                canvas.classList.add('locked');
                btn.textContent = 'üîí';
                btn.classList.add('active');
            } else {
                canvas.classList.remove('locked');
                btn.textContent = 'üîì';
                btn.classList.remove('active');
            }
        }

        // Toggle Grid
        function toggleGrid() {
            showGrid = !showGrid;
            const canvas = document.getElementById('canvas');
            const btn = document.getElementById('gridBtn');
            
            if (canvas && btn) {
                if (showGrid) {
                    canvas.classList.add('grid');
                    btn.classList.add('active');
                } else {
                    canvas.classList.remove('grid');
                    btn.classList.remove('active');
                }
                console.log('Grid toggled, showGrid:', showGrid);
            } else {
                console.error('Canvas or grid button not found', { canvas, btn });
            }
        }

        // Clear Canvas
        function clearCanvas() {
            if (layoutItems.length > 0 && confirm('Are you sure you want to clear all components?')) {
                layoutItems = [];
                selectedItem = null;
                renderCanvas();
                renderProperties();
                updateStats();
                saveHistory();
            }
        }

        // Update Stats
        function updateStats() {
            document.getElementById('availableCount').textContent = COMPONENTS.length;
            document.getElementById('canvasCount').textContent = layoutItems.length;
        }

        // Update Canvas Info
        function updateCanvasInfo() {
            document.getElementById('canvasInfo').textContent = 
                `Canvas: ${canvasWidth}√ó${canvasHeight}px ‚Ä¢ ${layoutItems.length} components`;
        }

        // Show Canvas Settings
        function showCanvasSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        // Apply Canvas Settings
        function applyCanvasSettings() {
            const width = parseInt(document.getElementById('canvasWidthInput').value);
            const height = parseInt(document.getElementById('canvasHeightInput').value);
            const key = document.getElementById('apiKeyInput').value.trim();
            const model = (document.getElementById('modelInput') && document.getElementById('modelInput').value.trim()) || modelName;
            
            if (width > 0 && height > 0) {
                canvasWidth = width;
                canvasHeight = height;
                
                const canvas = document.getElementById('canvas');
                canvas.style.width = canvasWidth + 'px';
                canvas.style.height = canvasHeight + 'px';
                
                renderCanvas();
            }
            
            if (key) {
                apiKey = key;
                localStorage.setItem('geminiApiKey', key);
            }
            if (model) {
                modelName = model;
                localStorage.setItem('geminiModel', modelName);
            }
            
            closeModal('settingsModal');
        }

        // Show Device Templates
        function showDeviceTemplates() {
            const list = document.getElementById('templatesList');
            list.innerHTML = DEVICE_TEMPLATES.map(template => `
                <div class="component-item" onclick="applyTemplate(${template.width}, ${template.height}); closeModal('templatesModal')">
                    <div class="component-icon" style="background: var(--primary)">${template.icon}</div>
                    <div class="component-info">
                        <div class="component-label">${template.name}</div>
                        <div class="component-type">${template.width}√ó${template.height}px</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('templatesModal').classList.add('active');
        }

        // Apply Template
        function applyTemplate(width, height) {
            canvasWidth = width;
            canvasHeight = height;
            
            const canvas = document.getElementById('canvas');
            canvas.style.width = canvasWidth + 'px';
            canvas.style.height = canvasHeight + 'px';
            
            document.getElementById('canvasWidthInput').value = width;
            document.getElementById('canvasHeightInput').value = height;
            
            renderCanvas();
        }

        // Close Modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // History Management
        function saveHistory() {
            const state = JSON.parse(JSON.stringify(layoutItems));
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }
            history.push(state);
            if (history.length > 50) history.shift();
            else historyIndex++;
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                layoutItems = JSON.parse(JSON.stringify(history[historyIndex]));
                selectedItem = null;
                renderCanvas();
                renderProperties();
                updateStats();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                layoutItems = JSON.parse(JSON.stringify(history[historyIndex]));
                selectedItem = null;
                renderCanvas();
                renderProperties();
                updateStats();
            }
        }

        // Generate Code with Gemini API
        async function generateCode() {
            if (layoutItems.length === 0) {
                alert('Please add components to your design first');
                return;
            }
            
            if (!apiKey) {
                alert('Please set your Gemini API key in Canvas Settings');
                showCanvasSettings();
                return;
            }
            
            // Show loading
            const fabIcon = document.getElementById('fabIcon');
            const fabLabel = document.getElementById('fabLabel');
            fabIcon.innerHTML = '<div class="spinner"></div>';
            fabLabel.textContent = 'Generating...';
            
            // Build component specifications
            let componentSpecs = '';
            layoutItems.forEach((item, index) => {
                if (!item.visible) return;
                
                componentSpecs += `
Component ${index + 1} (${item.component.type.toUpperCase()}):
- HTML Tag: ${item.component.tag}
- Position: left: ${Math.round(item.x)}px, top: ${Math.round(item.y)}px
- Dimensions: width: ${Math.round(item.width)}px, height: ${Math.round(item.height)}px
- Text Content: "${item.text}"
- Background: ${item.bgColor}
- Gradient: ${item.gradientFrom ? `${item.gradientFrom} to ${item.gradientTo} (${item.gradientDirection})` : 'none'}
- Text Color: ${item.textColor}
- Typography: ${Math.round(item.fontSize)}px, weight: ${item.fontWeight}, align: ${item.textAlign}, line-height: ${item.lineHeight}
- Border: ${item.borderWidth}px ${item.borderStyle} ${item.borderColor}, radius: ${Math.round(item.borderRadius)}px
- Shadow: ${item.shadowX}px ${item.shadowY}px ${item.shadowBlur}px ${item.shadowColor}
- Spacing: padding ${item.padding}px, margin ${item.margin}px
- Effects: opacity ${item.opacity.toFixed(2)}, rotation ${Math.round(item.rotation)}deg, filter: ${item.filter}, cursor: ${item.cursor}
- Animation: ${item.animation}
- Z-Index: ${item.zIndex}

`;
            });
            
            const prompt = `You are a senior full-stack developer and UI/UX designer. Generate PIXEL-PERFECT, production-ready HTML/CSS code that EXACTLY replicates this modern UI design with professional styling.

CANVAS SPECIFICATIONS:
- Container Dimensions: ${canvasWidth}px √ó ${canvasHeight}px
- Total Components: ${layoutItems.filter(i => i.visible).length}
- Design Style: Modern, clean, professional web interface

COMPONENT SPECIFICATIONS:
${componentSpecs}

TECHNICAL REQUIREMENTS & MODERN UI FEATURES:
1. Use semantic HTML5 tags as specified with proper structure
2. Implement absolute positioning for EXACT component placement
3. Apply ALL specified styling: gradients, shadows, borders, filters, animations
4. Include modern CSS features: custom properties, flexbox, grid where appropriate
5. Add smooth CSS transitions and hover effects for interactive elements
6. Implement responsive design with proper viewport settings
7. Use modern color palettes and typography (system fonts, proper font weights)
8. Add proper accessibility attributes (ARIA labels, focus states, semantic markup)
9. Include CSS animations and micro-interactions for enhanced UX
10. Apply modern design patterns: cards, buttons with hover states, proper spacing

ADVANCED STYLING REQUIREMENTS:
- Implement all gradients with specified directions
- Apply box-shadows exactly as specified for depth and elevation
- Use border-radius values for modern rounded corners
- Apply all filter effects (blur, brightness, contrast, grayscale, sepia)
- Implement CSS animations and keyframes for specified animations
- Add proper typography with line-height, letter-spacing, font-weight
- Apply cursor styles for better user experience
- Use z-index for proper layering and depth

MODERN UI ELEMENTS TO ENHANCE:
- Style buttons with gradients, shadows, and hover effects
- Make cards with elevation shadows and rounded corners
- Add smooth transitions (0.2s-0.3s) for interactive states
- Use modern color schemes and proper contrast ratios
- Implement loading states and micro-animations where appropriate
- Add subtle background patterns or textures if suitable

OUTPUT FORMAT:
- Complete HTML document with embedded CSS
- Include modern CSS reset and normalize
- Add responsive meta viewport tag
- Use CSS custom properties for theming
- Include hover and focus states for interactive elements
- Add comments explaining complex styling sections

The generated code must be PIXEL-PERFECT and MODERN - every position, gradient, shadow, animation, and styling property must match exactly. Create a professional, modern web interface that looks like it was designed by a top UI/UX designer.

Generate ONLY the complete HTML code with embedded CSS. No explanations or markdown blocks.`;

            try {
                // Use server-side proxy for secure API calls
                const response = await fetch('/api/generate-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        modelName: modelName
                    })
                });

                if (!response.ok) {
                    // Try to extract error details
                    let errorDetails = '';
                    try {
                        const errorData = await response.json();
                        errorDetails = errorData.error || errorData.message || 'Unknown error';
                    } catch (err) {
                        errorDetails = await response.text();
                    }
                    
                    const errMsg = `Server Error: ${response.status} ${response.statusText}\nDetails: ${errorDetails}`;
                    console.error(errMsg);
                    
                    // If server endpoint doesn't exist, fallback to direct API call
                    if (response.status === 404) {
                        console.log('Server endpoint not found, falling back to direct API call...');
                        return await fallbackDirectApiCall(prompt, modelName, apiKey, fabIcon, fabLabel);
                    }
                    
                    // Display the error in the code panel
                    document.getElementById('codeContent').innerHTML = `<pre style="color: #ffb4b4;">${escapeHtml(errMsg)}</pre>`;
                    throw new Error(errMsg);
                }

                const data = await response.json();
                const generatedCode = data.candidates[0].content.parts[0].text;
                
                // Clean up code (remove markdown fences if present)
                let cleanCode = generatedCode || '';
                // If the model wrapped the HTML in markdown fences like ```html ... ```
                // extract the content inside the fences. Otherwise, strip any stray fences.
                const fenceMatch = cleanCode.match(/```(?:\w+)?\n([\s\S]*?)\n```/);
                if (fenceMatch) {
                    cleanCode = fenceMatch[1].trim();
                } else if (cleanCode.includes('```')) {
                    // fallback: remove any remaining fence markers
                    cleanCode = cleanCode.replace(/```/g, '').trim();
                }
                
                // Display code
                document.getElementById('codeContent').innerHTML = `<pre>${escapeHtml(cleanCode)}</pre>`;
                document.getElementById('copyCodeBtn').style.display = 'block';
                document.getElementById('previewBtn').style.display = 'inline-block';
                document.getElementById('clearCodeBtn').style.display = 'inline-block';
                
                // Store code for copying
                window.generatedCode = cleanCode;
                // Update preview iframe if modal open or if user clicks preview
                const previewFrame = document.getElementById('previewFrame');
                if (previewFrame) previewFrame.srcdoc = cleanCode;
                
                // Reset FAB
                fabIcon.textContent = '‚ú®';
                fabLabel.textContent = 'Generate Code';
                
                alert('‚úÖ Code generated successfully!');
            } catch (error) {
                console.error('Server proxy failed:', error);
                
                // Try fallback with stored API key if server proxy fails
                try {
                    const storedApiKey = localStorage.getItem('geminiApiKey');
                    if (!storedApiKey) {
                        throw new Error('Server proxy unavailable and no API key found in local storage. Please set your Gemini API key in Canvas Settings.');
                    }
                    
                    console.log('Attempting fallback to direct API call...');
                    await fallbackDirectApiCall(prompt, modelName, storedApiKey, fabIcon, fabLabel);
                    
                } catch (fallbackError) {
                    console.error('Both server proxy and direct API failed:', fallbackError);
                    alert('‚ùå Error: ' + fallbackError.message);
                    
                    // Reset FAB
                    fabIcon.textContent = '‚ú®';
                    fabLabel.textContent = 'Generate Code';
                }
            }
        }

        // Fallback function for direct API calls (when server proxy is not available)
        async function fallbackDirectApiCall(prompt, modelName, apiKey, fabIcon, fabLabel) {
            if (!apiKey) {
                throw new Error('API key not found. Please set your Gemini API key in Canvas Settings.');
            }

            const requestUrl = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(modelName)}:generateContent?key=${apiKey}`;
            const response = await fetch(requestUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: prompt }]
                    }]
                })
            });

            if (!response.ok) {
                let bodyText = '';
                try {
                    bodyText = await response.text();
                } catch (err) {
                    bodyText = '<unable to read response body>';
                }
                throw new Error(`Direct API Error: ${response.status} ${response.statusText}\nBody: ${bodyText}`);
            }

            const data = await response.json();
            const generatedCode = data.candidates[0].content.parts[0].text;
            
            // Clean up code (remove markdown fences if present)
            let cleanCode = generatedCode || '';
            const fenceMatch = cleanCode.match(/```(?:\w+)?\n([\s\S]*?)\n```/);
            if (fenceMatch) {
                cleanCode = fenceMatch[1].trim();
            } else if (cleanCode.includes('```')) {
                cleanCode = cleanCode.replace(/```/g, '').trim();
            }
            
            // Display code
            document.getElementById('codeContent').innerHTML = `<pre>${escapeHtml(cleanCode)}</pre>`;
            document.getElementById('copyCodeBtn').style.display = 'block';
            document.getElementById('previewBtn').style.display = 'inline-block';
            document.getElementById('clearCodeBtn').style.display = 'inline-block';
            
            // Store code for copying
            window.generatedCode = cleanCode;
            const previewFrame = document.getElementById('previewFrame');
            if (previewFrame) previewFrame.srcdoc = cleanCode;
            
            // Reset FAB
            fabIcon.textContent = '‚ú®';
            fabLabel.textContent = 'Generate Code';
            
            alert('‚úÖ Code generated successfully using direct API!');
        }

        // Copy Code
        function copyCode() {
            if (window.generatedCode) {
                navigator.clipboard.writeText(window.generatedCode).then(() => {
                    alert('‚úÖ Code copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                });
            }
        }

        // Show preview modal with current generated code
        function showPreview() {
            if (!window.generatedCode) {
                alert('No generated code available to preview.');
                return;
            }
            const frame = document.getElementById('previewFrame');
            if (frame) frame.srcdoc = window.generatedCode;
            document.getElementById('previewModal').classList.add('active');
        }

        function openPreviewInNewTab() {
            if (!window.generatedCode) return alert('No generated code to open.');
            const w = window.open();
            w.document.open();
            w.document.write(window.generatedCode);
            w.document.close();
        }

        // Simple scroll-based navigation for mobile
        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }

        // Simplified functions for very small screens only
        function toggleLeftSidebar() {
            // Only for very small screens
            if (window.innerWidth <= 575) {
                const left = document.getElementById('leftSidebar');
                const backdrop = document.getElementById('sidebarBackdrop');
                
                if (left && backdrop) {
                    const isOpen = left.classList.contains('open');
                    
                    if (!isOpen) {
                        left.classList.add('open');
                        backdrop.classList.add('show');
                        document.body.style.overflow = 'hidden';
                    } else {
                        closeLeftSidebar();
                    }
                }
            } else {
                // For larger screens, just scroll to section
                scrollToSection('leftSidebar');
            }
        }

        function toggleRightSidebar() {
            // Only for very small screens
            if (window.innerWidth <= 575) {
                const right = document.getElementById('rightSidebar');
                const backdrop = document.getElementById('sidebarBackdrop');
                
                if (right && backdrop) {
                    const isOpen = right.classList.contains('open');
                    
                    if (!isOpen) {
                        right.classList.add('open');
                        backdrop.classList.add('show');
                        document.body.style.overflow = 'hidden';
                    } else {
                        closeRightSidebar();
                    }
                }
            } else {
                // For larger screens, just scroll to section
                scrollToSection('rightSidebar');
            }
        }

        function closeLeftSidebar() {
            const left = document.getElementById('leftSidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            
            if (left) left.classList.remove('open');
            if (backdrop) backdrop.classList.remove('show');
            document.body.style.overflow = '';
        }

        function closeRightSidebar() {
            const right = document.getElementById('rightSidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            
            if (right) right.classList.remove('open');
            if (backdrop) backdrop.classList.remove('show');
            document.body.style.overflow = '';
        }

        function closeMobileSidebars() {
            closeLeftSidebar();
            closeRightSidebar();
        }

        // Clear generated code and reset preview
        function clearCode() {
            const codeContent = document.getElementById('codeContent');
            codeContent.innerHTML = `
                <div class="code-placeholder">
                    <div class="code-placeholder-icon">üíª</div>
                    <p><strong>Create your design and generate code</strong></p>
                    <p>Add components to the canvas and click "Generate Code"</p>
                </div>
            `;
            
            // Hide action buttons
            document.getElementById('copyCodeBtn').style.display = 'none';
            document.getElementById('previewBtn').style.display = 'none';
            document.getElementById('clearCodeBtn').style.display = 'none';
            
            // Clear stored code and preview
            window.generatedCode = null;
            const previewFrame = document.getElementById('previewFrame');
            if (previewFrame) previewFrame.srcdoc = '';
        }



        // Escape HTML for display
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize app
        init();
    </script>
    
    <!-- Bootstrap JavaScript Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
